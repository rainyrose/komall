<?
	if(!$select_date) {
		$select_date = date("Y-m-d");
		$query_sdate = $select_date . " 00:00:00";
		$query_edate = $select_date . " 23:59:59";
	} else {
		if($tb == "type2"){
			$query_sdate = $select_date . "-01" . " 00:00:00";
			$query_edate = $select_date . "-31" . "23:59:59";
		} else if($tb == "type3"){
			$query_sdate = $select_date . "-01-01" . " 00:00:00";
			$query_edate = $select_date . "-12-31" . " 23:59:59";
		} else {
			$query_sdate = $select_date . " 00:00:00";
			$query_edate = $select_date . " 23:59:59";
		}
	}
?>

				<nav class="lnb small">
					<!-- 선택시 a태그 class="on" -->
					<ul>
						<li><a href="/ko_mall/index.html?type=setting&core=manager_setting&manager_type=sales" class="on">일일매출</a></li>
						<li><a href="/ko_mall/index.html?type=setting&core=manager_setting&manager_type=sales&mode=type1">기간별매출</a></li>
						<li><a href="/ko_mall/index.html?type=setting&core=manager_setting&manager_type=sales&mode=type2">월간매출</a></li>
						<li><a href="/ko_mall/index.html?type=setting&core=manager_setting&manager_type=sales&mode=type3">연간매출</a></li>
					</ul>
				</nav>


				<div class="box pd">
					<!-- 검색결과 나왔을때 괄호 노출 -->
					<h2>일일매출 (<?=$select_date?>)</h2>
					<div class="search_bbs">
						<form action="<?=$common_queryString?>" id="sdate" method="POST">
							<input type="text" name="select_date" value="<?=$select_date?>" class="input100 datepicker" data-form-type="datepicker" id="" title="시작날짜">
							<input type="submit" value="검색" class="button sm gray">
						</form>
					</div>

				<table class="table thColor tar">
					<caption>건수별 안내</caption>
					<colgroup>
						<col style="width:8%"/>
						<col style="width:12%"/>
						<col style="width:8%"/>
						<col style="width:12%"/>
						<col style="width:8%"/>
						<col style="width:12%"/>
						<col style="width:8%"/>
						<col style="width:12%"/>
						<col style="width:8%"/>
						<col style="width:12%"/>
					</colgroup>
					<tbody>
						<?
						$total_show_query = "SELECT count(distinct(order_id)) AS total_,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a1,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '입금대기' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a2_1,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '입금확인중' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a2_11,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '결제완료' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a2,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '상품준비중' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a3,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '배송준비' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a4,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '배송중' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a41,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '취소요청' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a5,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '취소완료' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a51,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '교환요청' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a6,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '교환진행중' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a61,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '반품요청' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a7,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE state = '반품진행중' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a71,
									(SELECT count(distinct(order_id)) FROM koweb_order WHERE (state = '주문완료' OR state = '배송완료') AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a8,
									(SELECT (SUM(product_price)+SUM(deli_price) + SUM(deli_add_price)) FROM koweb_order WHERE reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a12,
									(SELECT SUM(pay_price) FROM koweb_order WHERE reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a13,
									(SELECT (SUM(product_price)+SUM(deli_price) + SUM(deli_add_price) - SUM(use_point)) - SUM(pay_price) + SUM(return_price) FROM koweb_order WHERE reg_date >= '$query_sdate' AND reg_date <= '$query_edate' AND !(state='취소완료' OR state='반품완료')) AS a14,
									##(SELECT SUM(product_price)+SUM(deli_price) + SUM(deli_add_price) - SUM(use_point) FROM koweb_order WHERE reg_date >= '$query_sdate' AND reg_date <= '$query_edate' AND state='취소') AS a15,
									(SELECT (SUM(product_price)+SUM(deli_price) + SUM(deli_add_price)) FROM koweb_order WHERE reg_date >= '$query_sdate' AND reg_date <= '$query_edate' AND (state='취소완료')) AS a15,
									(SELECT SUM(return_price) FROM koweb_order WHERE reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a16,
									(SELECT SUM(pay_price) FROM koweb_order WHERE reg_date >= '$query_sdate' AND reg_date <= '$query_edate' AND state='취소완료') AS a16_1,
									(SELECT SUM(product_price) + SUM(deli_price) + SUM(deli_add_price) - SUM(use_point) - SUM(return_price) FROM koweb_order WHERE state!='취소' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate') AS a17

									FROM koweb_order";
						$total_show = mysqli_fetch_array(mysqli_query($connect, $total_show_query));
						?>
						<tr>
							<th scope="row" class="bg_thBlue">총주문건수</th>
							<td><?=number_format($total_show[a1])?></td>
							<th scope="row">진행 중인 건수</th>
							<td><?=number_format($total_show[a2_1]+$total_show[a2_11]+$total_show[a2]+$total_show[a3]+$total_show[a4]+$total_show[a41])?></td>
							<th scope="row">취소건수</th>
							<td><?=number_format($total_show[a5]+$total_show[a51])?></td>
							<th scope="row">교환,반품건수</th>
							<td><?=number_format($total_show[a6]+$total_show[a61]+$total_show[a7]+$total_show[a71])?></td>
							<th scope="row">완료건수</th>
							<td><?=number_format($total_show[a8])?></td>
						</tr>
						<tr>
							<th scope="row" class="bg_thBlue">총주문금액</th>
							<td><?=number_format($total_show[a12])?>원</td>
							<th scope="row">결제금액</th>
							<td><?=number_format($total_show[a13])?>원</td>
							<th scope="row">취소금액</th>
							<td><?=number_format($total_show[a15])?>원</td>
							<th scope="row">환불금액</th>
							<td><?=number_format($total_show[a16])?>원</td>
							<th scope="row">미수금액</th>
							<td><?=number_format($total_show[a14])?>원</td>
						</tr>
						<tr>
							<th scope="row" class="bg_thBlue">최종 금액</th>
							<td colspan="9"><?=number_format($total_show[a13]-$total_show[a16])?>원</td>
						</tr>
					</tbody>
				</table>

					<?
					$query = "SELECT * FROM koweb_order WHERE order_info='P' AND reg_date >= '$query_sdate' AND reg_date <= '$query_edate' ORDER BY state ASC";
					$total = mysqli_num_rows(mysqli_query($connect, $query));
					$result = mysqli_query($connect, $query);
					?>

					<!-- 검색결과 -->
					<table class="table" style="margin-top:20px;">
						<caption>일일매출현황</caption>
						<thead>
							<tr>
								<th scope="col">주문번호</th>
								<th scope="col">주문자</th>
								<th scope="col">주문합계</th>
								<th scope="col">무통장</th>
								<th scope="col">가상계좌</th>
								<th scope="col">계좌이체</th>
								<th scope="col">휴대폰</th>
								<th scope="col">카드입금</th>
								<th scope="col">적립금사용</th>
								<th scope="col">결제금액</th>
								<th scope="col">미수금</th>
								<th scope="col">주문취소</th>
								<th scope="col">환불금액</th>
								<th scope="col">최종금액</th>
								<th scope="col">상태</th>
							</tr>
						</thead>
						<tbody>
						<? if($total > 0){ ?>
						<? while($row = mysqli_fetch_array($result)){
							$sub_query = "SELECT sum(pay_price) as pay_price1,sum(product_price) as product_price1,sum(use_point) as use_point1 FROM koweb_order WHERE order_id='{$row[order_id]}' group by order_id";
							$sub_result = mysqli_query($connect, $sub_query);
							$sub_row = mysqli_fetch_array($sub_result);
							// print_r($sub_row);
							$row[pay_price] = $sub_row['pay_price1'];
							$row[product_price] = $sub_row['product_price1'];
							if($row[state] == "취소완료"){
								$row[use_point] = 0;
							}else{
								$row[use_point] = $sub_row['use_point1'];
							}

							?>
							<? if(!$row[name]) $row[name] = "비회원"; ?>
							<? $total_price = ($row[product_price] + $row[deli_price] + $row[deli_add_price] - $row[use_point]); ?>
							<? $row[$row[pay_type]] = $row[pay_price]; ?>
							<? $no_return_pay = ($total_price - $row[pay_price]) + $row[return_price]; ?>
							<?
							$cancel_price = 0;
							if($row[pay_price] == 0) $cancel_price = $total_price;
							else $cancel_price = $total_price;

							$return_price = $row[return_price];
							if($row['state'] == "취소완료")$return_price = $row[pay_price];
							?>
							<tr>
								<td><a href="/ko_mall/index.html?type=setting&core=manager_setting&manager_type=order&mode=order_view&orderid=<?=$row[order_id]?>"><?=$row[order_id]?></a></td>
								<td><?=$row[name]?></td>
								<td><?=number_format($total_price+$row[use_point])?>원</td>
								<td><?=number_format($row[무통장입금])?></td>
								<td><?=number_format($row[가상계좌])?></td>
								<td><?=number_format($row[계좌이체])?></td>
								<td><?=number_format($row[휴대폰])?></td>
								<td><?=number_format($row[신용카드])?></td>
								<td><?=number_format($row[use_point])?></td>
								<td class="bg_blue"><?=number_format($row[$row[pay_type]])?>원</td>
								<td class="bg_red"><?=$row[state] == "취소완료" || $row[state] == "반품완료" ? "0" : number_format($no_return_pay)?>원</td>
								<td class="bg_blue"><? if($row[state] == "취소완료"){ ?><?=number_format($cancel_price)?><? } else { ?>0<?}?>원</td>
								<td class="bg_red"><?=number_format($row[return_price])?>원</td>
								<!-- <td class="bg_blue"><?=$row[state] == "취소완료" ? "0" : number_format($total_price-$no_return_pay)?>원</td> -->
								<td class="bg_blue"><?=number_format($total_price-$no_return_pay)?>원</td>
								<td class="bg_blue"><?=$row[state]?></td>
							</tr>
						<? } ?>
						<? } else { ?>
							<!-- 결과없을때 -->
							<tr>
								<td colspan="14">검색된 결과가 없습니다.</td>
							</tr>
						<? } ?>
						</tbody>
					</table>
					<!-- //검색결과 -->
				</div>
