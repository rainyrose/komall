<?
if (!$auth_write) error("There is no right to write.");

$modes_title = "writing";
$row[name] = $_SESSION['member_name'];


if($mode == "modify"){
	$query = "SELECT * FROM $board_id WHERE no='$no'";
	$result = mysqli_query($connect, $query);
	$row = mysqli_fetch_array($result);
	$mode_title = "Edit";

	//관리자가 아님
	if(!$is_admin){
		if($board[is_membership] != "Y"){
		//password가 없음
			if($password == ""){
				url("$common_queryString&amp;mode=check&amp;return_mode=$mode&amp;no=$row[no]");
				exit;
			}
			$password = hash("sha256", $password);
			//password가 틀림
			if($row[password] != $password){
				alert("This post can only be checked by the author and the administrator.");
				url("$common_queryString&amp;mode=check&amp;return_mode=$mode&amp;no=$row[no]");
				exit;
			}
		} else {
			if($_SESSION[member_id] != $row[id]){
				error("This post can only be edited by the author and administrator.");
				exit;
			}
		}
	}
	$id = $row['category'];
}

$chk_query = "SELECT * FROM koweb_product WHERE no='{$id}'";
$chk_result = mysqli_query($connect, $chk_query);
$chk_row = mysqli_num_rows($chk_result);
$chk_product = mysqli_fetch_array($chk_result);
if($chk_row == 0) error("Incorrect access. (No product information)");

if($mode == "write"){
	$chk_query = "SELECT * FROM koweb_order WHERE member='{$_SESSION['member_id']}' AND ref_product='{$chk_product['id']}' AND (state='complete' OR state='Refund Completed' OR state='Canceled') AND order_id='{$order_id}'";
	$chk_result = mysqli_query($connect, $chk_query);
	$order_rows = mysqli_num_rows($chk_result);

	$chk_query = "SELECT * FROM $board_id WHERE id='{$_SESSION['member_id']}' AND category='{$id}' AND order_id='{$order_id}'";
	$chk_result = mysqli_query($connect, $chk_query);
	$board_rows = mysqli_num_rows($chk_result);

	if(($order_rows - $board_rows) <= 0) error("You cannot leave a review on this product.");
}

$score_target_arr = array("very unsatisfied"=>0,"dissatisfaction"=>1,"usually"=>2,"Satisfaction"=>3,"very good"=>4);

?>
<form action="<?=$common_queryString?>" method="post" name="form" enctype="multipart/form-data">
<input type="hidden" name="mode" id="mode" value="<?=$mode?>_proc" />
<input type="hidden" name="board_id" id="board_id" value="<?=$board_id?>" />
<input type="hidden" name="site_language" id="site_language" value="<?=$site_language?>" />
<input type="hidden" name="return_url" value="<?=$add_folder?>/member/member.html?board_id=<?=$board_id?>&mode=review" />
<input type="hidden" name="no" value="<?=$row[no]?>" />
<input type="hidden" name="ref_no" value="<?=$ref_no?>" />
<input type="hidden" name="tag_type" value="<?=$tag_type?>" />
<input type="hidden" name="sms_auth_" id="sms_auth_" value="<?=$board[sms_auth]?>" />
<input type="hidden" name="is_admin_" id="is_admin_" value="<?=$is_admin?>" />
<input type="hidden" name="order_id" id="order_id" value="<?=$order_id?>" />

<table class="bbsView">
	<caption>Board <?=$mode_title?></caption>
	<colgroup>
		<col data-write="th" style="width:15%"/>
		<col data-write="td" style="width:85%"/>
	</colgroup>
	<tbody>
		<!-- <tr>
			<th scope="row"><label for="title">상품</label></th>
			<td><img src="/upload/product/<?=$chk_product['title_img']?>" /></td>
		</tr> -->
		<tr>
			<th scope="row"><label for="title">product name</label></th>
			<td><?=$chk_product['product_title']?></td>
		</tr>
		<tr>
			<th scope="row"><span class="marking">Required item</span><label for="title">title</label></th>
			<td><input type="text" name="title" id="title" class="inputFull required" value="<?=$row[title]?>" title="title"/></td>
		</tr>
		<? if($_SESSION['member_id'] == "koweb"){ ?>
		<tr>
			<th scope="row">For meta tag keywords</th>
			<td>
				<input type="text" name="metatag_content" class="inputFull"><?=$row[metatag_content]?></textarea>
			</td>
		</tr>
		<? } ?>
		<tr>
			<th scope="row"><span class="marking">Required item</span><label for="name">Writer</label></th>
			<td><input type="text" name="name" id="name" value="<?=$row[name]?>" class="required" <?=$mem_option?> title="Writer" /></td>
		</tr>
		<input type="hidden" name="category" id="category" value="<?=$id?>" class="required" />
		<tr>
			<th scope="row"><span class="marking">Required item</span>Satisfaction</th>
			<td>
				<div class="designRadio eval">
					<input title='Satisfaction' type="radio" class='required_radio' name="review_score" id="review_score1" value='very unsatisfied'><label for="review_score1"><span data-shop-accordion="eval"><i class="on">very unsatisfied</i><i>dissatisfaction</i><i>usually</i><i>Satisfaction</i><i>very good</i></span></label>
					<input title='Satisfaction' type="radio" class='required_radio' name="review_score" id="review_score2" value='dissatisfaction'><label for="review_score2"><span data-shop-accordion="eval"><i class="on">very unsatisfied</i><i class="on">dissatisfaction</i><i>usually</i><i>Satisfaction</i><i>very good</i></span></label>
					<input title='Satisfaction' type="radio" class='required_radio' name="review_score" id="review_score3" value='usually'><label for="review_score3"><span data-shop-accordion="eval"><i class="on">very unsatisfied</i><i class="on">dissatisfaction</i><i class="on">usually</i><i>Satisfaction</i><i>very good</i></span></label>
					<input title='Satisfaction' type="radio" class='required_radio' name="review_score" id="review_score4" value='Satisfaction'><label for="review_score4"><span data-shop-accordion="eval"><i class="on">very unsatisfied</i><i class="on">dissatisfaction</i><i class="on">usually</i><i class="on">Satisfaction</i><i>very good</i></span></label>
					<input title='Satisfaction' type="radio" class='required_radio' name="review_score" id="review_score5" value='very good'><label for="review_score5"><span data-shop-accordion="eval"><i class="on">very unsatisfied</i><i class="on">dissatisfaction</i><i class="on">usually</i><i class="on">Satisfaction</i><i class="on">very good</i></span></label>
				</div>
			</td>
		</tr>
		<!-- <tr>
			<th scope="row">Secret</th>
			<td>
				<div class="designCheck">
					<input type="checkbox" name="secret" id="secret" value="Y" /><label for="secret">Use secret article</label>
				</div>
			</td>
		</tr> -->
		<? if($is_admin){ ?>
			<tr>
				<th scope="row">Announcement</th>
				<td>
					<div class="designCheck">
						<input type="checkbox" name="notice" id="notice" value="Y" /><label for="notice">Announcement</label>
					</div>
				</td>
			</tr>
		<? } ?>
		<? if($board[sms_auth] == "Y" && $mode != "modify" && !$is_admin){ ?>
			<tr>
				<th scope="row"><span class="marking">Required item</span>Enter your mobile number</th>
				<td class="tel">
					<input type="text" name="phone1" id="phone1" class="input100 required" value="<?=$phone[0]?>" maxlength="3" title="Mobile phone first digit number"/> -
					<input type="text" name="phone2" id="phone2" class="input100 required" value="<?=$phone[1]?>" maxlength="4" title="Mobile phone second digit number"/> -
					<input type="text" name="phone3" id="phone3" class="input100 required" value="<?=$phone[2]?>" maxlength="4" title="Mobile phone third digit number"/>
					<a href="#" onclick="sms_send();" class="button white">Get Verification Number</a>
				</td>
			</tr>
			<tr>
				<th scope="row"><span class="marking">Required item</span>Certification number input</th>
				<td>
					<input type="text" name="sms_auth" value="" class="input200 required" id="sms_auth" title="Certification Number"/>
					<span id="auth_message"><a href="#" onclick="sms_auth();" class="button">Confirm</a></span>
					<input type="hidden" name="sms_auth2" id="sms_auth2" value="" class="auth_required" />
				</td>
			</tr>
		<? } ?>
		<tr>
			<th scope="row">Contents</th>
			<td>
				<textarea name="comments" id="smart_content" rows="2" cols="2" style="width:100%; ; height:412px;" class="inputFull"><?=$row[comments]?></textarea>
			</td>
		</tr>
		<? if($_SESSION['member_id'] == "koweb"){ ?>
		<tr>
			<th scope="row">For keywords</th>
			<td>
				<textarea name="etc" rows="1" cols="2" class="inputFull"><?=$row[etc]?></textarea>
			</td>
		</tr>
		<? } ?>
		<? if($board[file_count] != 0){ ?>
		<tr>
			<th scope="row">Attachments</th>
				<td>
				<?
					for($i = 1; $i <= $board[file_count]; $i++) {
							$file_title = $row["file_".$i];
							$del_ = "File selection";
							$del_2 = "";
							$del_3 = "";
							if($file_title){
								 $del_2 = "<label for='file_$i' class='button white'><span>Existing Attachment : <a href='/upload/$board_id/$file_title' target='_blank'>$file_title</a></label>";
								 $del_3 = "<div class='designCheck mb10' style='display:inline-block;'><input type='checkbox' value='Y' id='del_$i' name='del_$i'/><label for='del_$i'>Delete file</label></div>";
							}
							echo "<div class='designFile'><input type='text' readonly='readonly' value=''/><input type='file' name='file_$i' id='file_$i'/><label for='file_$i' class='button white'> $del_</label> $del_2 $del_3</div>";
					 }
				?>
				<em class="tip">Attachable file size is <?=$board[file_limit_size]?>MB</em>
			</td>
		</tr>
		<? } ?>
		<? if($board[spam_auth] == "Y"){ ?>
		<? $_SESSION[rand_auth] = rand(0000,9999); ?>
			<tr>
				<th scope="row"><span class="marking">Required item</span><label for="state">Antispam</label></th>
				<td class="spam"><span><?=$_SESSION[rand_auth]?></span><input type="text" name="rand_auth_" placeholder="Please enter the left number." class="input200 required" title="Antispam letter" /></td>
			</tr>
		<? } ?>
		<? if($board[is_membership] != "Y"){ ?>
		<tr>
			<th scope="row"><span class="marking">Required item</span><label for="pin">password</label></th>
			<td>
				<input type="password" name="password" id="pin" value="" class="required" title="password"  />
				<em class="tip">※ Required to edit or delete posts.</em>
			</td>
		</tr>
		<? } ?>
	</tbody>
</table>
<script type="text/javascript">
	$(":checkbox[name='notice'][value='<?=$row['notice']?>']").prop("checked", true);
	$(":checkbox[name='secret'][value='<?=$row['secret']?>']").prop("checked", true);
	$(":radio[name='review_score'][value='<?=$row['review_score']?>']").prop("checked", true);

</script>
<!-- //writing -->
<!-- 버튼 -->
<div class="btn_area">
	<input type="submit" class="button" value="Save" />
	<a href="<?=$common_queryString?>" class="button gray">cancel</a>
</div>
</form>

<!-- //버튼 -->
