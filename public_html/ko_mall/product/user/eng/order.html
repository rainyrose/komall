<?
if($total_data){
	$total_data = htmlspecialchars_decode($_POST[total_data]);
}
/*
$not = array(
		array("product_id" => "21055359", "options" => "3", "add_options" => "5535201|1", "option_flag" => "N"),
		array("product_id" => "T5013", "options" => "6080484|4", "add_options" => "", "option_flag" => "Y"),
		array("product_id" => "A3", "options" => "14178241|4^9832992|4", "add_options" => "B1|2", "option_flag" => "Y")
);
*/

//print_r($total_data);

//shopping basket시
if($total_data){
	$options_json = json_decode(urldecode($total_data), true);
	$options_json1 = json_encode($options_json);
	$options_json = array_filter($options_json);
} else {
	//Buy now시
	$options_json = array(array("product_id" => $product_id, "options" => $options, "add_options" => $add_options, "option_flag" => $option_flag));
	$options_json1 = json_encode($options_json);
}

$order_id = get_micreotime();
$_SESSION[options_checker] = $options_json1;
?>
<div id="div_ajax_load_image" style='display:none;' >
	<div class="area_loding">
		<img src="/ko_mall/images/common/loading.gif" class="img" alt="loading">
	</div>
</div>
<script language="javascript" src="https://pretest.uplus.co.kr:9443/xpay/js/xpay_crossplatform.js" type="text/javascript"></script>
<script src="https://www.paypal.com/sdk/js?client-id=<?=PAYPAL_CLIENT_ID?>&commit=false"></script>




			<form action="<?=$_SERVER[PHP_SELF]?>" method="POST" enctype="application/json" name="LGD_PAYINFO" id="LGD_PAYINFO">
			<input type="hidden" name="mode" value="order_proc" />
			<input type="hidden" name="add_delivery_price" value="<?=get_add_delivery_price($connect, $_SESSION[member_id])?>" data-add-deliveryhidden/>
			<input type="hidden" name="id" value="<?=$id?>" />
			<input type="hidden" name="category" value="<?=$category?>" />
			<input type="hidden" name="option_" value="<?=htmlspecialchars($options_json1, ENT_QUOTES)?>" />
			<input type="hidden" name="order_id" value="<?=$order_id?>" />
			<input type="hidden" name="ref_product" value="<?=$product_id?>" />
			<input type="hidden" name="toid" value="" />
			<div class="area_shopCart">


				<a href="#" data-shop-view="addcordion">Order <em>(<?=count($options_json)?>)</em></a>

				<div data-shop-view="addcordion_conts">
					<table class="table">
						<caption>Products List</caption>
						<colgroup>
							<col/>
							<col style="width:10%"/>
							<col style="width:12%"/>
							<col style="width:10%"/>

							<col style="width:10%"/>
						</colgroup>
						<thead>
							<tr>
								<th scope="col">Product Information</th>
								<th scope="col">price</th>
								<th scope="col">Quantity</th>
								<!-- <th scope="col">accumulate</th> -->

								<th scope="col">Sum</th>
							</tr>
						</thead>
						<tbody>
						<?
						$price_check = 0;
						$ik = 0;
						$jk = 0;

						$check_cnt_product_array = array();
						$product_id_array = array();
						foreach($options_json AS $json){

							$option_flag = $json[option_flag];
							$options = $json[options];
							$add_options = $json[add_options];
							$product_id = $json[product_id];
							$product_id_array[] = $product_id;
							if($option_flag == "Y"){
								$options_data = explode("^", $options);
							} else {
								$options_data = $options;
								$options_data = array($id."|".$options);
							}

							$add_options_data = explode("^", $add_options);
							$add_options_data = array_filter($add_options_data);

							$options_data = array_filter($options_data);

							$product_ = mysqli_fetch_array(mysqli_query($connect, "SELECT * FROM koweb_product WHERE id = '$product_id' LIMIT 1"));
							if($product_[use_telform] == "Y") $site_pay[use_uplus] = "N";
							foreach($options_data AS $odata){

								$option_detail = explode("|", $odata);

								if(!$option_detail[1] || $option_detail[1] == "0"){
									error("Abnormal approach. Not the right quantity");
									exit;
								}

								if($product_[min_count])
								$check_cnt_product_array[$product_[id]]['min'] = $product_[min_count];
								if($product_[max_count])
								$check_cnt_product_array[$product_[id]]['max'] = $product_[max_count];
								$check_cnt_product_array[$product_[id]]['cnt'] = $check_cnt_product_array[$product_[id]]['cnt'] + $option_detail[1];
								$check_cnt_product_array[$product_[id]]['title'] = $product_[product_title];

								$option_ = mysqli_fetch_array(mysqli_query($connect, "SELECT * FROM koweb_option_detail WHERE id='$option_detail[0]' AND ref_product = '$product_[no]' LIMIT 1"));

								if($option_[price_type] == "+"){
									$option_detail_price = $product_[price] + $option_[price];
								} else if($option_[price_type] == "-") {
									$option_detail_price = $product_[price] - $option_[price];
								} else {
									//option이 없을때
									$option_detail_price = $product_[price];
								}

								$option_price = ($option_detail_price * $option_detail[1]);
								$price_check += $option_price;

								if($product_[point_type] == "2"){
									$option_point = ($option_price * ($product_[point_detail] / 100));
								}

						?>
								<tr>
									<td data-cart-table="product" class="tal">
										<div data-cart-option="img">

											<a href="/<?=$add_folder?>product/product.html?mode=view&id=<?=$product_[id]?>" class="img"><img src="/upload/product/<?=$product_[title_img]?>" alt=""/></a>
											<div>

												<em><?=$product_[product_title]?></em>


												<? if($option_flag == "Y"){?>
												<i>[ option : <?=$option_[title]?> ]</i>
												<? } ?>

											</div>
										</div>
									</td>
									<? if($product_[use_telform] != "Y"){ ?>
									<td data-cart-table="price" data-price-conv="option_price" data-uniq-odp="<?=$ik?>"><?=number_format($option_detail_price)?>won</td>
									<? }else{ ?>
									<td data-cart-table="price">Contact us</td>
									<? } ?>
									<td data-cart-table="count"><?=$option_detail[1]?></td>
									<!-- <td data-cart-table="point"><?=number_format($option_point)?> P</td> -->

									<? if($product_[use_telform] != "Y"){ ?>
									<td data-cart-table="total" data-price-conv="total_price" data-uniq-op="<?=$ik?>"><?=number_format($option_price)?>won</td>
									<? }else{ ?>
									<td data-cart-table="total">Contact us</td>
									<? } ?>
								</tr>
							<? $ik++; } ?>

							<?
								foreach($add_options_data AS $aodata){
									$add_option_detail = explode("|", $aodata);
									$add_option_ = mysqli_fetch_array(mysqli_query($connect, "SELECT * FROM koweb_option_detail WHERE id='$add_option_detail[0]' AND ref_product = '$product_[no]' ANd otype='add' LIMIT 1"));

									if($add_option_[price_type] == "+"){
										$add_option_detail_price = 0 + $add_option_[price];
									} else if($add_option_[price_type] == "-") {
										$add_option_detail_price = 0 - $add_option_[price];
									}


									$add_option_price = ($add_option_detail_price * $add_option_detail[1]);
									$price_check += $add_option_price;

									//포인트 직접설정
									if($product_[point_type] == "2"){
										$add_option_point = ($add_option_price * ($product_[point_detail] / 100));
									}


								?>
									<tr>
										<td data-cart-table="product" class="tal">
											<div data-cart-option="img">

												<a href="/<?=$add_folder?>product/product.html?mode=view&id=<?=$product_[id]?>" class="img"><img src="/upload/product/<?=$product_[title_img]?>" alt=""/></a>
												<div>

													<em>[Additional options] <?=$add_option_[title]?></em>


												</div>
											</div>
										</td>
										<td data-cart-table="price" data-price-conv="add_option_price" data-uniq-aodp="<?=$jk?>"><?=number_format($add_option_detail_price)?>won</td>
										<td data-cart-table="count"><?=$add_option_detail[1]?></td>
										<!-- <td data-cart-table="point"><?=number_format($add_option_point)?> P</td> -->

										<td data-cart-table="total" data-price-conv="add_total_price" data-uniq-aop="<?=$jk?>"><?=number_format($add_option_price)?>won</td>
									</tr>
								<?
							$jk++;}
						}
						foreach ($check_cnt_product_array as $k_product_id => $k_product_value) {
							if($k_product_value[min] && $k_product_value[cnt] < $k_product_value[min]){error("[".$k_product_value[title]."] The minimum number of purchases for a product is ".$k_product_value[min].".");}
							if($k_product_value[max] && $k_product_value[cnt] > $k_product_value[max]){error("[".$k_product_value[title]."] The maximum number of purchases for a product is ".$k_product_value[max].".");}
						}
						 ?>
						</tbody>
					</table>
				</div>

				<div data-cart-option="info">
					<a href="#" onclick="javascript:history.go(-1);" class="button white">Previous screen</a>
					<p class="icon_shopInfo">You can change product options and quantities in the product details or in the shopping cart..</p>
				</div>
			</div>
			<?
			if($_SESSION[order_type] == "member"){
				$query = "SELECT * FROM koweb_member WHERE id = '$_SESSION[member_id]' AND state='Y' LIMIT 1";
				$result = mysqli_query($connect, $query);
				$row = mysqli_fetch_array($result);

				$point_ = mysqli_fetch_array(mysqli_query($connect, "SELECT SUM(point) AS total FROM koweb_point WHERE member='$row[id]'"));
				$order_query = "SELECT * FROM koweb_order WHERE member='$_SESSION[member_id]' AND order_info='P' AND price_type='USD' ORDER BY no DESC";
				$order_result = mysqli_query($connect, $order_query);
				$order_row = mysqli_fetch_array($order_result);
				$row[address1] = $order_row[address1];
				$row[address2] = $order_row[address2];
				$row[address3] = $order_row[address3];
				$row[zip] = $order_row[zip];
				$row[phone] = $order_row[phone];

				$email = explode("@", $row[email]);
			}?>
				<script type="text/javascript">
					function mail_check(){
						if($("#tmp_mail").val() == "other"){
							$("#email2").val("");
							$("#email2").prop("disabled", "");
						} else {
							$("#email2").val("");
							$("#email2").val($("#tmp_mail").val());
							$("#email2").prop("disabled", "disabled");
						}
							$("#email3").val($("#email2").val());
					}
				</script>
				<script type="text/javascript">
					$(function() {
						$("select[name='tmp_email'] option[value='<?=$email[1]?>']").prop("selected", true);
						$("select[name='tmp_mail'] option[value='<?=$email[1]?>']").prop("selected", true);
						$("select[name='phone1'] option[value='<?=$phone[0]?>']").prop("selected", true);
					});
				</script>

			<div class="area_shopPay">
				<p class="title">Shipping Information</p>
				<table class="bbsView">
					<caption>Shipping Information</caption>
					<colgroup>
						<col data-write="th" style="width:15%"/>
						<col data-write="td" style="width:35%"/>
						<col data-write="th" style="width:15%"/>
						<col data-write="td" style="width:35%"/>
					</colgroup>
					<tbody>

						<? if($_SESSION[order_type] == "guest"){?>
						<tr>
							<th scope="row"><span class="marking">Required input</span>Orderer ID</th>
							<td colspan="3">
								<strong><?=$_SESSION['member_id']?></strong>
								<em class="tip">(Required for nonmember order tracking)</em>
							</td>
						</tr>
						<tr>
							<th scope="row"><span class="marking">Required input</span>Order password</th>
							<td>
								<input type="password" name="password" id="password">
								<p class="tip">(Alphanumeric characters, 6 to 12 characters)</p>
							</td>
							<th scope="row"><span class="marking">Required input</span>Confirm Password</th>
							<td><input type="password" name="password_re" id="password_re"></td>
						</tr>
						<tr>
							<th scope="row"><span class="marking">Required input</span>e-mail</th>
							<td colspan="3" class="mail">
								<input type="text" name="email1" id="email1" value="<?=$email[0]?>" class="<?=$email_required?>" title="e-mail"/> @
								<select name="tmp_mail" id="tmp_mail" onchange="javascript:mail_check();" class="input150">
									<option value="">Choose</option>
									<option value="naver.com">naver.com</option>
									<option value="daum.net">daum.net</option>
									<option value="hanmail.net">hanmail.net</option>
									<option value="hotmail.com">hotmail.com</option>
									<option value="gmail.com">gmail.com</option>
									<option value="other">Direct input</option>
								</select>
								<input type="text" name="email2" value="<?=$email[1]?>" id="email2" disabled class="<?=$email_required?>" title="e-mail"/>
							</td>
						</tr>
						<? } ?>
						<tr>
							<th scope="row"><span class="marking">Required input</span><label for="name">Receiver</label></th>
							<td><input type="text" name="name" id="name" value="<?=$row[name]?>" class="inputFull"></td>
							<th scope="row"><span class="marking">Required input</span><label for="zip">Postcode</label></th>
							<td><input type="text" name="zip" id="zip" value="<?=$row[zip]?>" class="inputFull"></td>
						</tr>
						<tr>
							<th scope="row"><span class="marking">Required input</span><label for="address1">City</label></th>
							<td><input type="text" name="address1" id="address1" value="<?=$row[address1]?>" class="inputFull"/></td>
							<th scope="row"><span class="marking">Required input</span><label for="address2">House no./ Street</label></th>
							<td><input type="text" name="address2" id="address2" value="<?=$row[address2]?>" class="inputFull"/></td>
						</tr>
						<tr>
							<th scope="row"><span class="marking">Required input</span><label for="address3">State<label></th>
							<td><input type="text" name="address3" id="address3" value="<?=$row[address3]?>" class="inputFull"/></td>
							<th scope="row"><span class="marking">Required input</span>Cell Phone</th>
							<td>
								<input type="text" name="phone" id="phone" value="<?=$row[phone]?>" class="inputFull"/>
							</td>
						</tr>
						<tr>
							<th scope="row">Shipping message</th>
							<td colspan="3">
								<textarea name="memo" id="memo" class="inputFull"><?=$row[memo]?></textarea>
							</td>
						</tr>
					</tbody>
				</table>
				<? if($_SESSION[order_type] == "member" && $product_[use_telform] != "Y"){?>


				<!-- <p class="title">Use of points</p>
				<div data-shop-view="point">
					<div>
						<em>Use of points <p style="font-size:12px;">(100point unit)</p></em>
						<span><input type="text" name="use_point" id="use_point" class="input100" data-keyup-point/> point</span>
					</div>
					<div>
						<ul>
							<li>
								<em>Retention Point</em>
								<span><?=number_format($point_[total])?>point</span>
							</li>

						</ul>
					</div>
				</div> -->

				<? } ?>

			</div>



			<a href="#" data-shop-view="addcordion" class="show">Billing Information</a>


			<div data-shop-view="addcordion_conts" data-cart-option="total">
				<? if($product_[use_telform] != "Y"){ ?>

				<div class="price">
					<em>Total purchase amount</em>
					<span data-product-total><?=number_format($price_check)?>won</span>
				</div>


				<span>+</span>
				<div class="deliver">
					<em>shipping fee</em>
					<? $delivery_ = get_delivery_price($connect, $product_id_array, $price_check); ?>
					<span data-delivery><?=number_format($delivery_)?>won</span>
				</div>


				<!-- <span>+</span>
				<div class="deliver_add">
					<em>Additional shipping</em>
					<? $delivery_add = 	get_add_delivery_price($connect, $_SESSION[member_id]); ?>
					<span data-add-delivery><?=number_format($delivery_add)?>won</span>
				</div> -->


				<!-- <span class="minus">-</span>
				<div class="point">
					<em>Point discount</em>
					<span data-use-point>0point</span>
				</div> -->




				<span>=</span>
				<div class="total">
					<em>Estimated amount of payment</em>
					<? $expected = $price_check+$delivery_+$delivery_add; ?>
					<input type="hidden" data-expected-price value="<?=$expected?>" />
					<span data-expected-price><?=number_format($expected)?>won</span>
				</div>
				<? }else{ ?>
				<div class="total">
				<em><?=$mall_config[company_phone]?></em>
				<span data-expected-price>Contact us</span>
				</div>
				<? } ?>
			</div>



			<? if($_SESSION[order_type] == "guest"){ ?>


			<a href="#" data-shop-view="addcordion" class="show">Agreement</a>


			<div data-shop-view="addcordion_conts">
				<div class="area_shop_agree">
					<div class="designCheck first">
						<input type="checkbox" id="allagree"/><label for="allagree">I agree to the shopping mall terms of use and the agreement to use personal information when purchasing non-members.</label>
					</div>
					<dl>
						<dt>Consent to Collection and Use of Personal Information</dt>
						<dd>

							<div class="scroll">
								<?=htmlspecialchars_decode($site_pay[sinfo1_eng])?>
							</div>
							<div class="designCheck">
								<input type="checkbox" name="agree1" id="agree1"/><label for="agree1">I agree.</label>
							</div>
						</dd>
						<dt>Shopping Mall Terms of Use</dt>
						<dd>

							<div class="scroll">
								<?=htmlspecialchars_decode($site_pay[sinfo2_eng])?>
							</div>
							<div class="designCheck">
								<input type="checkbox" name="agree2" id="agree2"/><label for="agree2">I agree.</label>
							</div>
						</dd>
						<dt>Consent to Collection of Personal Information</dt>
						<dd>

							<div class="scroll">
								<?=htmlspecialchars_decode($site_pay[sinfo3_eng])?>
							</div>
							<div class="designCheck">
								<input type="checkbox" name="agree3" id="agree3"/><label for="agree3">I agree.</label>
							</div>
						</dd>
						<dt>Agree to receive shopping information</dt>
						<dd>

							<div class="scroll">
								<?=htmlspecialchars_decode($site_pay[sinfo4_eng])?>
							</div>
							<div class="designCheck">
								<input type="checkbox" name="agree4" id="agree4"/><label for="agree4">I agree.</label>
							</div>
						</dd>
					</dl>
				</div>
			</div>

			<? } ?>




			<a href="#" data-shop-view="addcordion" class="show">method of payment</a>

			<div data-shop-view="addcordion_conts" class="area_shop_payment">
				<p class="title">method of payment</p>
				<div class="designRadio blue">
					<input type="radio" name="pay_type" id="pay_type1" checked value="Bank Deposit" data-pay-type="direct"/><label for="pay_type1">Bank Deposit</label>
					<!--
					<? if($site_pay[use_uplus] == "Y"){ ?>
						<input type="radio" name="pay_type" id="pay_type5" value="신용카드" data-pay-type="SC0010"/><label for="pay_type5">Credit card</label>
						<input type="radio" name="pay_type" id="pay_type3" value="계좌이체" data-pay-type="SC0030"/><label for="pay_type3">Bank Transfer</label>
						<? if($site_pay[use_phone_pay] == "Y"){?>
						<input type="radio" name="pay_type" id="pay_type4" value="휴대폰" data-pay-type="SC0060"/><label for="pay_type4">cellphone</label>
						<? } ?>
						<? if($site_pay[use_culture_pay] == "Y"){?>
						<input type="radio" name="pay_type" id="pay_type6" value="문화상품권" data-pay-type="SC0111"/><label for="pay_type6">Cultural Gift Certificate</label>
						<? } ?>
						<? if($site_pay[use_tel_pay] == "Y"){?>
						<input type="radio" name="pay_type" id="pay_type7" value="유선전화결제" data-pay-type="SC0070"/><label for="pay_type7">Landline Phone Payment</label>
						<? } ?>
					<? } ?>
					-->
					<? if($product_[use_telform] != "Y"){ ?>
					<input type="radio" name="pay_type" id="pay_type12" value="paypal" data-pay-type="paypal"/><label for="pay_type12">PAYPAL</label>
					<? } ?>
				</div>

				<? $use_direct_list = explode("/:koweb2:/", nl2br($site_pay[use_direct_content_eng])); ?>
				<div class="bankbook">
					<ul>
						<li>
							<em>Choose bank</em>
							<span>
								<select name="bank_info" id="bank_info" class="input300">
									<option value="">Please select</option>
									<?
									foreach($use_direct_list AS $dl){
									$dl_ = explode("/:koweb:/",$dl);
									$dl_[0] = str_replace("<br />","",$dl_[0]);
									$dl_[0] = str_replace("\r","",$dl_[0]);
									$dl_[0] = str_replace("\n","",$dl_[0]);
									?>
									<option value="<?=$dl_[0]?>"><?=$dl_[0]?></option>
									<? } ?>
								</select>
							</span>
						</li>
						<li>
							<em>Depositor Name</em>
							<span>
								<input type="text" name="bank_name" id="bank_name" class="input200" title="Depositor Name 입력" value="<?=$row[name]?>">
							</span>
						</li>
						<!-- <li class="cash_paper">
							<em>Cash receipts</em>
							<span>
								<select name="cash_paper_type" id="cash_paper_type" class="input200">
									<option value="">Choose</option>
									<option value="For income deduction">For income deduction</option>
									<option value="Proof of expenditure">Proof of expenditure</option>
								</select>
								<select name="cash_paper_method" id="cash_paper_method" class="input200">
									<option value="">Choose</option>
									<option value="Mobile Phone Number" data-cash-paper="For income deduction">Mobile Phone Number</option>
									<option value="Cash receipt card" data-cash-paper="For income deduction">Cash receipt card</option>
									<option value="Other cards" data-cash-paper="For income deduction">Other cards</option>
									<option value="Business Number" data-cash-paper="Proof of expenditure">Business Number</option>
								</select>
							</span>
							<span>
								<input type="text" name="cash_paper_data" id="cash_paper_data" placeholder="Enter information (Please enter numbers only)" value="">
							</span>
						</li> -->
						<script type="text/javascript">
							$(function(){
								$("#cash_paper_type option[value='']").prop("selected", true);
								$("#cash_paper_type").change(function(){
									var this_ = $(this);
									$("#cash_paper_method option[value='']").prop("selected", true);

									$("#cash_paper_method option").each(function(){
										if($(this).data("cash-paper") == $(this_).val()){
											$(this).show();
										} else {
											$(this).hide();
										}
									});
								});
							});
						</script>
					</ul>


					<?
					foreach($use_direct_list AS $dl){
					$dl_ = explode("/:koweb:/",$dl);
					$dl_[0] = str_replace("<br />","",$dl_[0]);
					$dl_[0] = str_replace("\r","",$dl_[0]);
					$dl_[0] = str_replace("\n","",$dl_[0]);
					$dl_[1] = str_replace("<br />","",$dl_[1]);
					$dl_[1] = str_replace("\r","<br />",$dl_[1]);
					?>
					<p data-bank-name="<?=$dl_[0]?>" class="info" style="display:none;">
						<?=preg_replace("/\<br \/\>/","",$dl_[1],1)?>
					</p>
					<? } ?>
				</div>

			</div>
			<script>
			$("#bank_info").change(function(){
				$("[data-bank-name]").hide();
				$("[data-bank-name='"+$(this).val()+"']").show();
			})
			</script>









			<div data-cart-option="total" class="area_shop_final">

				<div class="method">
					<em>Payment Method</em>
					<span data-pay-type>Bank Deposit</span>
				</div>
				<span></span>
				<div class="total">
					<em>Final payment amount</em>
					<? if($product_[use_telform] != "Y"){ ?>
					<span data-total-price><?=number_format($expected)?> won</span>
					<? }else{ ?>
					<span data-total-price>Contact us</span>
					<? } ?>
				</div>
			</div>


			<div class="designCheck">
				<input type="checkbox" name="agree5" id="agree5"/><label for="agree5">I have confirmed my payment information and agree to the purchase.</label>
			</div>


			<div class="btn_area">
				<input type="submit" class="button lg" value="Place an order" data-payment-proc>
				<a href="#" class="button lg white" onclick="javascript:history.go(-1);">Cancel</a>
			</div>
		</form>


		<div id="popLayer01" data-pop-layer="layer" style="display:none;">
			<div class="popBox mini">
				<h2><span>PAYPAL</span></h2>
				<div class="popConts">
					<div id="paypal-button-container"></div>
				</div>
			</div>
		</div>

<div id="areag"></div>
<script src="/js/pay.js"></script>
<script type="text/javascript">
	$("#allagree").change(function(){
		if($(this).is(":checked")){
			if($("#agree1").length){
				$("#agree1").prop("checked", true);
			}

			if($("#agree2").length){
				$("#agree2").prop("checked", true);
			}

			if($("#agree3").length){
				$("#agree3").prop("checked", true);
			}

			if($("#agree4").length){
				$("#agree4").prop("checked", true);
			}
		} else {
			if($("#agree1").length){
				$("#agree1").prop("checked", false);
			}

			if($("#agree2").length){
				$("#agree2").prop("checked", false);
			}

			if($("#agree3").length){
				$("#agree3").prop("checked", false);
			}

			if($("#agree4").length){
				$("#agree4").prop("checked", false);
			}
		}
	});

	$(function(){
		$("form").submit(function(){
			var chk = true;


			if($("#name").val() == ""){
				alert("Please enter the recipient");
				chk = false;
				return false;
			}

			if($("#zip").val() == "" || $("#address1").val() == "" || $("#address2").val() == ""){
				alert("Please enter your address.");
				chk = false;
				return false;
			}

			if("<?=$_SESSION[order_type]?>" == "guest"){
				if($("#password").val() == ""){
					alert("Please enter your order tracking password");
					chk = false;
					return false;
				}

				if($("#password_re").val() != $("#password").val()){
					alert("Please check your order tracking password");
					chk = false;
					return false;
				}

				if(!$("#agree1").is(":checked")) {
					alert("You must agree to the collection and use of personal information to purchase.");
					chk = false;
					return false;
				}

				if(!$("#agree2").is(":checked")) {
					alert("You must agree to the mall terms and conditions to purchase.");
					chk = false;
					return false;
				}

				if(!$("#agree3").is(":checked")) {
					alert("Purchase is possible only if you agree to the use of personal information collection.");
					chk = false;
					return false;
				}

				if(!$("#agree4").is(":checked")) {
				//	alert("Agree to receive shopping information에 동의하여야 구매가 가능합니다.");
				//	return false;
				}
			} else {

				if($("#phone").val() == ""){
					alert("Please enter your phone.");
					chk = false;
					return false;
				}

			}
			if($("input[type=radio][name=pay_type]:checked").val() == "Bank Deposit"){
				if(!$("select[name=bank_info]").val()) {
					alert("Please select a deposit bank.");
					chk = false;
					return false;
				}

				if(!$("input[name=bank_name]").val()) {
					alert("Please enter the name of the depositor.");
					chk = false;
					return false;
				}
			}

			if(!$("#agree5").is(":checked")) {
				alert("Please agree to purchase.");
				return false;
			}
			if(!chk) return false;

			if("<?=$site_pay[uplus_type]?>" == "Y"){
				var paymode = "test";
			} else {
				var paymode = "service";
			}
			var paytype = $("input[type=radio][name=pay_type]:checked").data("pay-type");
			var Ispaypal = $("input[name='toid']").val();
			if(paytype == "direct"){
				var origin_action = "<?=$_SERVER[PHP_SELF]?>";
				document.LGD_PAYINFO.action = origin_action;
				document.LGD_PAYINFO.target = "";
			} else if(paytype == "paypal"){
				if(Ispaypal == ""){
					showPopup(popLayer01);
					return false;
				}
			} else{
				doPay(paymode, paytype);
				//안써주면 실행안됨 doPay에서 처리됨
				return false;
			}

		});
	});

<? if($_SESSION[order_type] == "member"){?>
function open_address_list(){
	window.open("/product/address.html","Shipping list","width=400,height=700");
}

function get_main_address(num){
	var doc = window.document;
	if(num == 1){
		var phone = "<?=$row['phone']?>";
		var name = "<?=$row['name']?>";
		var zip = "<?=$row['zip']?>";
		var address1 = "<?=$row['address1']?>";
		var address2 = "<?=$row['address2']?>";
		var phoneList = phone.split("-");
		doc.getElementById("phone1").value = phoneList[0];
		doc.getElementById("phone2").value = phoneList[1];
		doc.getElementById("phone3").value = phoneList[2];
		doc.getElementById("name").value = name;
		doc.getElementById("zip").value = zip;
		doc.getElementById("address1").value = address1;
		doc.getElementById("address2").value = address2;
	}
	if(num == 2){
		$.ajax({
			type : "GET",
			url : "/ko_mall/product/user/ajax_get_main_address.php",
			success : function(args) {
				var res = JSON.parse(args);
				var phoneList = res.phone.split("-");
				doc.getElementById("phone1").value = phoneList[0];
				doc.getElementById("phone2").value = phoneList[1];
				doc.getElementById("phone3").value = phoneList[2];
				doc.getElementById("name").value = res.name;
				doc.getElementById("zip").value = res.zip;
				doc.getElementById("address1").value = res.address1;
				doc.getElementById("address2").value = res.address2;
			}
		});
	}
	if(num == 3){
		doc.getElementById("phone1").value = "";
		doc.getElementById("phone2").value = "";
		doc.getElementById("phone3").value = "";
		doc.getElementById("name").value = "";
		doc.getElementById("zip").value = "";
		doc.getElementById("address1").value = "";
		doc.getElementById("address2").value = "";
	}
}
<? } ?>
</script>

<script type="text/javascript">
$(function(){
	var option = <?= json_encode($options_json); ?>;
	var zip = $("input[name='zip']").val();

	$.ajax({
		type : "POST",
		url : "/product/convert_price_ajax.php",
		data : {
			mode : "USD",
			option : option,
			zip : zip
		},
		success : function(args) {
			var result = JSON.parse(args);
			var option_add = result.add;
			var option_ori = result.option;


			for(var i = 0; i < option_ori.length; i++){
				$("[data-uniq-op="+i+"]").text(option_ori[i].option_price +" USD");
				$("[data-uniq-odp="+i+"]").text(option_ori[i].option_detail_price +" USD");
			}
			if(option_add){
				for(var j = 0; j < option_add.length; j++){
					$("[data-uniq-aop="+j+"]").text(option_add[j].add_option_price +" USD");
					$("[data-uniq-aodp="+j+"]").text(option_add[j].add_option_detail_price +" USD");
				}
			}

			$("span[data-expected-price]").text(result.total + " USD");
			$("span[data-product-total]").text(result.product_total + " USD");
			$("span[data-delivery]").text(result.delivery_price + " USD");
			$("span[data-add-delivery]").text(result.delivery_add_price + " USD");
			$("[data-total-price]").text(result.total + " USD");
		}
	});
})
var expected = 0;
	$("input[type=radio][name=pay_type]").change(function(){

		if($(this).val() == "paypal"){
			$(".bankbook").hide();
		} else {
			if($(this).val() == "Bank Deposit"){
				$(".bankbook").show();
			} else {
				$(".bankbook").hide();
			}
		}

		$("[data-pay-type]").text($(this).next("label").text());
	});
</script>
<script type="text/javascript">
$(function(){
	// $("#div_ajax_load_image").css("display","block");
})
	$(document).on("focusout", "[data-keyup-point]", function(){

		var limit_ = parseInt("<?=$point_[total]?>");
		if($(this).val() % 100 !== 0){
			alert("Points can be used in units of 100 points..");
			$(this).val("");
			return false;
		}

		if($(this).val() > parseInt("<?=$expected?>")){
			alert("It cannot be used higher than the final payment amount.");
			$(this).val("");
			return false;
		}

		if(parseInt($(this).val()) > limit_){
			alert("There are not enough remaining points.");
			$(this).val("");
			return false;
		}

		if(!$(this).val()){

			$("[data-use-point]").text("0point");
			$("[data-expected-price]").text(number_format(parseInt("<?=$expected?>"))+"won");
			$("[data-total-price]").text(number_format(parseInt("<?=$expected?>")));
			return false;
		}

		$("[data-use-point]").text(number_format($(this).val())+"point");
		$("[data-expected-price]").text(number_format(parseInt("<?=$expected?>") - parseInt($(this).val()))+"won");
		$("[data-total-price]").text(number_format(parseInt("<?=$expected?>") - parseInt($(this).val())));
	});

  paypal.Buttons({
    createOrder: function(data, actions) {

	// var expected = parseInt("<?=$expected?>");
	var expected = <?=convert_price_for_order($options_json)?>;
	// var expected = parseInt(expected);
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: expected
          }
        }]
      });
    },
    onApprove: function(data, actions) {
		$("#div_ajax_load_image").css("display","block");
      return actions.order.capture().then(function(details) {
        //alert('Transaction completed by ' + details.payer.name.given_name);
        // Call your server to save the transaction
		 if (details.error === 'INSTRUMENT_DECLINED') {
			return actions.restart();
		 }

		if(details.status == "COMPLETED"){
			$("input[name='toid']").val(data.orderID);
			//alert(data.orderID);
			document.LGD_PAYINFO.action = origin_action;
			document.LGD_PAYINFO.target = "";
			document.LGD_PAYINFO.submit();
		} else {
			alert("Payment failure");
			$("#div_ajax_load_image").css("display","none");
		}

      });
    }
  }).render('#paypal-button-container');
</script>
