<?
//페이징 변수
if (!$start) $start = 0;
$scale = 20; // 리스트 수
$page_scale	= 10; // 페이징 수
$common_queryString .= "&amp;search_cat=$search_cat";
if(!$is_admin){
	url($common_queryString."&amp;mode=write");
}
?>
<!-- 프로그램설정 -->	

<form action="<?=$_SERVER['PHP_SELF']?>" method="GET">
<? GETmake_form_action($common_actionString);?>
	<!-- 검색 -->
	<div class="search" style="margin-bottom:10px;">
		<select name="search_cat" id="search_cat">
			<option value="">전체</option>
			<option value="신청">신청</option>
			<option value="해지">해지</option>
		</select>

		<select name="search_key" id="searchType">
			<option value="">전체</option>
			<option value="id">ID</option>
			<option value="name">이름</option>
		</select>
		<input type="text" id="keyword" name="keyword" value="<?=$keyword?>">
		<input type="submit" class="button" value="검색">
		<a href="/ko_mall/program/koweb_magazine/excel.php?search_key=<?=$search_key?>&amp;search_cat=<?=$search_cat?>&amp;keyword=<?=$keyword?>" class="button blue">엑셀다운로드</a>
	</div>
	<!-- //검색 -->
</form>

<script type="text/javascript">
	$("select[name='search_cat'] option[value='<?=$search_cat?>']").attr("selected", true);
	$("select[name='search_key'] option[value='<?=$search_key?>']").attr("selected", true);
</script>


<table class="bbsList">
	<caption>매거진 설정</caption>
	<colgroup>
		<col style="width:7%"/>
		<col style="width:8%"/>
		<col style="width:8%" />
		<col style="width:10%"/>
		<col />
		<col style="width:12%"/>
		<col style="width:12%"/>
	</colgroup>
	<thead>
		<tr>
			<th scope="col">No.</th>
			<th scope="col">신청유형</th>
			<th scope="col">ID</th>
			<th scope="col">신청자</th>
			<th scope="col">주소</th>
			<th scope="col">등록일</th>
			<th scope="col">상태</th>
		</tr>
	</thead>
	<tbody>
		<?
			if($search_cat){
				$WHERE .= "AND magazine_type='$search_cat'";
			}

			if($keyword){
				if($search_key == ""){
					$WHERE .= "AND id LIKE '%$keyword%' OR name LIKE '%keyword%'";
				} else {
					$WHERE .= "AND $search_key LIKE '%$keyword%'";
				}
			}

			$total_query = "SELECT * FROM $program_table WHERE 1=1 $WHERE ORDER BY no DESC";
			$result = mysqli_query($connect, $total_query);
			$total = mysqli_num_rows($result);
			$query = "SELECT * FROM $program_table WHERE 1=1 $WHERE ORDER BY no DESC LIMIT $start, $scale";
			$result2 = mysqli_query($connect, $query);
			$f_no = $total - $start;
			if($total > 0){
				while($row = mysqli_fetch_array($result2)){ 
				?>
				<tr>
					<td><?=$f_no--?></td>
					<td><?=$row[magazine_type]?></td>
					<td><?=$row[id]?></td>
					<td><?=$row[name]?></td>
					<td class="tal"><?=$row[zip]?> <?=$row[address1]?> <?=$row[address2]?> </td>
					<td><?=$row[reg_date]?></td>
					<td>
						<a href="<?=$common_queryString?>&amp;mode=modify&amp;no=<?=$row[no]?>" class="button sm gray">수정</a>
						<a href="<?=$common_queryString?>&amp;mode=delete&amp;no=<?=$row[no]?>" class="button sm">삭제</a>
					</td>
				</tr>
			<? } ?>
		<? } else { ?>
			<? 
				if($is_admin) $col = "6";
				else $col = "5";
			?>
			<tr>
				<td colspan="<?=$col?>">등록된 데이터가 없습니다.</td> 
			</tr>
		<? } ?>
	</tbody>
</table>
<? if($is_admin){ ?>
<div class="btn_area">
	<a href="<?=$common_queryString?>&mode=write" class="button lg"/>매거진 신청 등록</a>
</div>
<? } ?>
<div class="pagination">
	<?
		/*----------------------------------------------------------------------------*/
		// 페이지 표시
		/*----------------------------------------------------------------------------*/

		if ($total == 0) $total = 1;

		$page_url = $common_queryString."&amp;search_cat=$search_cat";

		// 처음
		echo "<a href='$page_url&amp;start=0' class='btn_first'><span>맨처음</span></a>";

		$page = floor($start / ($scale * $page_scale));

		if ($start + $scale >  $scale * $page_scale) {
			$pre_start = $start - $scale * $page_scale ;
			echo "<a href='$page_url&amp;start=$pre_start' class='btn_prev'><span>이전</span></a>";
		}

		for ($vj = 0; $vj < $page_scale ; $vj++) {
			$ln = ($page * $page_scale + $vj) * $scale;
			$vk = $page * $page_scale + $vj + 1 ;

			if ($ln < $total) {
				if ($ln != $start) echo "<a href='$page_url&amp;start=$ln'>$vk</a>";
				else echo "<span>$vk</span>";
			}
		}

		// 마지막
		$end_page = floor($total - $scale) + 1;
		if ($end_page <= 0)	$end_page = 0;

		if ($total > (($page + 1) * $scale * $page_scale)) {
			$n_start = ($page + 1) * $scale * $page_scale ;
			echo "<a href='$page_url&amp;start=$n_start' class='btn_next'><span>다음</span></a>";
		}

		$end_page = ceil($total / $scale);
		if ($total) $end_start = ($end_page -1) * $scale;
		else $end_start = $end_page;

		echo "<a href='$page_url&amp;start=$end_start' class='btn_last'><span>맨마지막</span></a>";
	?>
</div>